import{d as K,r as u,I as S,o as Y,f as d,g as r,h as e,t as l,k as b,n as o,p as i,J as C,K as h,F as A,D as j,L as g,z as F,i as I,w as G,j as z,v as H,l as U,G as J,_ as Q}from"./index-0fEq5Ai7.js";import{u as Z}from"./project-BptAyBNN.js";import{f as P,d as $,a as ee,h as V}from"./forms-7iAXV4Wl.js";import"./construction-DkjzJ5BA.js";const se={class:"container-xxl"},te={class:"row justify-content-center"},le={class:"col-xl-12"},ae={class:"d-flex align-items-center mb-3"},oe={class:"breadcrumb"},ie={class:"breadcrumb-item active"},ne={class:"page-header mb-0"},de={class:"row"},re={class:"col-lg-4 mb-4"},ce={class:"mb-3"},me={class:"d-flex align-items-center mb-2"},ue={class:"badge border border-primary text-primary px-2 pt-5px pb-5px rounded fs-12px d-inline-flex align-items-center me-2"},fe={class:"badge border border-secondary text-secondary px-2 pt-5px pb-5px rounded fs-12px d-inline-flex align-items-center"},ve={class:"mb-2"},pe={class:"text-muted small mb-3"},_e={class:"mb-3"},be={class:"row text-center"},he={class:"col-6"},ge={class:"border rounded p-2"},xe={class:"fw-bold"},ye={class:"col-6"},we={class:"border rounded p-2"},ke={class:"fw-bold small"},Ce={class:"small"},De={class:"col-lg-8 mb-4"},Se={class:"row"},Ae={class:"d-flex align-items-start mb-3"},je={class:"flex-grow-1"},ze={class:"d-flex align-items-center mb-2"},Me={class:"mb-0 me-2"},Be={key:0,class:"fa fa-check-circle text-success"},Ne={class:"text-muted small mb-2"},Te={class:"mb-2"},Fe={class:"d-flex justify-content-between align-items-center mb-1"},Ie={class:"badge border border-secondary text-secondary px-2 pt-5px pb-5px rounded fs-12px d-inline-flex align-items-center"},Ue={class:"text-muted"},Pe={class:"small text-muted"},$e={class:"small text-muted"},Ve=["onClick"],Oe={class:"row"},Re={class:"col-lg-8 mb-4"},Xe={class:"row"},Ee={class:"col-lg-6"},qe={class:"mb-3"},Le={class:"form-text small"},We={class:"col-lg-6"},Ke={class:"mb-3"},Ye={class:"form-check mb-2"},Ge={class:"form-check"},He={class:"d-flex justify-content-between align-items-center mt-3 pt-3 border-top"},Je={class:"text-muted"},Qe={key:0},Ze={key:1},es=["disabled"],ss={key:0,class:"mt-3"},ts={class:"d-flex justify-content-between align-items-center mb-2"},ls={class:"small"},as={class:"progress"},os={class:"col-lg-4 mb-4"},is={key:0,class:"text-center py-3"},ns={key:1},ds={class:"d-flex justify-content-between align-items-start mb-2"},rs={class:"mb-1 small"},cs=["onClick"],ms={class:"text-muted small mb-1"},us={class:"d-flex justify-content-between"},fs={class:"text-muted"},vs={class:"text-muted"},ps=K({__name:"FormA5Download",setup(_s){const O=Z();u(!1);const m=u(!1),f=u(0),x=u("standard"),y=u(""),M=u(!1),B=u(!0),c={code:"A-5",name:"估驗請款計價單",description:"估驗請款計價單是工程進度款項申請的重要文件，包含工程進度、計價項目、請款金額等內容。",category:"A類表單",version:"v2.1",lastUpdate:"2024-01-15",requiredFields:["工程基本資訊","計價項目明細","工程進度說明","請款金額計算","估驗資料","付款條件","附件清單"]},N=[{id:"taipei",name:"台北市政府建管處版本",description:"台北市建築管理工程處核定的估驗請款計價單格式",fileSize:"1.2 MB",format:"DOCX",preview:"/assets/img/forms/a5-taipei-preview.jpg",authority:"台北市政府建管處",lastUpdate:"2024-01-15"},{id:"newtaipei",name:"新北市政府工務局版本",description:"新北市政府工務局核定的估驗請款計價單格式",fileSize:"1.1 MB",format:"DOCX",preview:"/assets/img/forms/a5-newtaipei-preview.jpg",authority:"新北市政府工務局",lastUpdate:"2024-01-10"},{id:"taoyuan",name:"桃園市政府建管處版本",description:"桃園市政府建築管理處核定的估驗請款計價單格式",fileSize:"1.3 MB",format:"DOCX",preview:"/assets/img/forms/a5-taoyuan-preview.jpg",authority:"桃園市政府建管處",lastUpdate:"2024-01-20"},{id:"taichung",name:"台中市政府都發局版本",description:"台中市政府都市發展局核定的估驗請款計價單格式",fileSize:"1.0 MB",format:"DOCX",preview:"/assets/img/forms/a5-taichung-preview.jpg",authority:"台中市政府都發局",lastUpdate:"2024-01-12"},{id:"tainan",name:"台南市政府工務局版本",description:"台南市政府工務局核定的估驗請款計價單格式",fileSize:"1.4 MB",format:"DOCX",preview:"/assets/img/forms/a5-tainan-preview.jpg",authority:"台南市政府工務局",lastUpdate:"2024-01-18"},{id:"kaohsiung",name:"高雄市政府工務局版本",description:"高雄市政府工務局核定的估驗請款計價單格式",fileSize:"1.2 MB",format:"DOCX",preview:"/assets/img/forms/a5-kaohsiung-preview.jpg",authority:"高雄市政府工務局",lastUpdate:"2024-01-22"}],v=u([{id:1,fileName:"A-5_估驗請款計價單_台北市政府建管處版本_2024-01-15.docx",template:"台北市政府建管處版本",downloadTime:"2024-01-15 14:30:25",fileSize:"1.2 MB"},{id:2,fileName:"A-5_估驗請款計價單_新北市政府工務局版本_2024-01-10.docx",template:"新北市政府工務局版本",downloadTime:"2024-01-10 09:15:42",fileSize:"1.1 MB"}]),_=S(()=>N.find(a=>a.id===x.value)),T=S(()=>x.value&&!m.value),D=S(()=>{var n;if(y.value.trim())return y.value.trim();const s=new Date().toISOString().split("T")[0];return`A-5_估驗請款計價單_${((n=_.value)==null?void 0:n.name)||"台北市政府建管處版本"}_${s}`}),R=a=>{x.value=a},X=async()=>{var s,t;if(!T.value||m.value)return;console.log("開始下載流程，防止重複調用"),m.value=!0,f.value=0;let a=null;try{const n={constructionId:"CTq3CMSVeDUuBYCEM2KRkjl40DSjTnPf",title:y.value.trim()||D.value,supervisoryName:"",supervisoryFactory:"",contractDate:"",startDate:"",finishDate:"",workedDay:"",disbursementAdvancePayment:"",estimateAmount:"",adjustPriceIndex:"",deductAmount:"",retention:"",deductionAdvancePayment:"",comment:"",deductedColumnReason:"",explainActualAmount:""};a=setInterval(()=>{f.value<90&&(f.value+=Math.random()*10)},200),console.log("發送 A-5 下載請求，參數:",n);const p=await P.downloadReport(n);console.log("收到 blob 回應:",{size:p.size,type:p.type,isBlob:p instanceof Blob}),f.value=100,a&&(clearInterval(a),a=null);const L=((s=_.value)==null?void 0:s.format.toLowerCase())||"docx",k=`${D.value}.${L}`;console.log("準備下載檔案:",k),$(p,k),console.log("下載函數已執行");const W={id:v.value.length+1,fileName:k,template:((t=_.value)==null?void 0:t.name)||"",downloadTime:new Date().toLocaleString("zh-TW"),fileSize:ee(p.size)};v.value.unshift(W),v.value.length>10&&(v.value=v.value.slice(0,10)),w("下載成功！",`${k} 已開始下載`,"success")}catch(n){console.error("下載失敗:",n);const p=V(n);w("下載失敗",p,"error")}finally{a&&clearInterval(a),m.value=!1,f.value=0}},w=(a,s,t="success")=>{console.log(`${t}: ${a} - ${s}`)},E=a=>{w("預覽功能",`正在載入 ${a.name} 的預覽...`,"success")},q=async a=>{var s;try{m.value=!0;const t={constructionId:((s=O.currentProject)==null?void 0:s.constructionId)||"CTq3CMSVeDUuBYCEM2KRkjl40DSjTnPf",title:a.fileName.replace(".docx","").replace(".pdf",""),supervisoryName:"",supervisoryFactory:"",contractDate:"",startDate:"",finishDate:"",workedDay:"",disbursementAdvancePayment:"",estimateAmount:"",adjustPriceIndex:"",deductAmount:"",retention:"",deductionAdvancePayment:"",comment:"",deductedColumnReason:"",explainActualAmount:""},n=await P.downloadReport(t);$(n,a.fileName),w("重新下載成功",`${a.fileName} 已開始下載`,"success")}catch(t){const n=V(t);w("重新下載失敗",n,"error")}finally{m.value=!1}};return Y(()=>{}),(a,s)=>(r(),d("div",se,[e("div",te,[e("div",le,[e("div",ae,[e("div",null,[e("ol",oe,[s[3]||(s[3]=e("li",{class:"breadcrumb-item"},[e("a",{href:"javascript:;"},"表單生成與管理")],-1)),s[4]||(s[4]=e("li",{class:"breadcrumb-item"},[e("a",{href:"javascript:;"},"A類表單")],-1)),e("li",ie,l(c.code)+" "+l(c.name),1)]),e("h1",ne,[s[5]||(s[5]=e("i",{class:"fa fa-file-alt me-3"},null,-1)),b(" "+l(c.code)+" - "+l(c.name),1)])])]),e("div",de,[e("div",re,[o(g,{class:"h-100"},{default:i(()=>[o(C,null,{default:i(()=>s[6]||(s[6]=[e("div",{class:"d-flex align-items-center"},[e("i",{class:"fa fa-info-circle me-2"}),e("h5",{class:"mb-0"},"表單資訊")],-1)])),_:1,__:[6]}),o(h,null,{default:i(()=>[e("div",ce,[e("div",me,[e("span",ue,l(c.code),1),e("span",fe,l(c.category),1)]),e("h6",ve,l(c.name),1),e("p",pe,l(c.description),1)]),e("div",_e,[e("div",be,[e("div",he,[e("div",ge,[s[7]||(s[7]=e("div",{class:"text-muted small"},"版本",-1)),e("div",xe,l(c.version),1)])]),e("div",ye,[e("div",we,[s[8]||(s[8]=e("div",{class:"text-muted small"},"更新日期",-1)),e("div",ke,l(c.lastUpdate),1)])])])]),e("div",null,[s[10]||(s[10]=e("h6",{class:"mb-2"},"必填欄位",-1)),e("div",Ce,[(r(!0),d(A,null,j(c.requiredFields,t=>(r(),d("div",{key:t,class:"d-flex align-items-center mb-1"},[s[9]||(s[9]=e("i",{class:"fa fa-check-circle text-success me-2"},null,-1)),b(" "+l(t),1)]))),128))])])]),_:1})]),_:1})]),e("div",De,[o(g,{class:"h-100"},{default:i(()=>[o(C,null,{default:i(()=>s[11]||(s[11]=[e("div",{class:"d-flex align-items-center"},[e("i",{class:"fa fa-layer-group me-2"}),e("h5",{class:"mb-0"},"選擇模板")],-1)])),_:1,__:[11]}),o(h,null,{default:i(()=>[e("div",Se,[(r(),d(A,null,j(N,t=>e("div",{key:t.id,class:"col-lg-4 mb-3"},[o(g,{class:F(["h-100 cursor-pointer template-card",{"border-theme":x.value===t.id}]),onClick:n=>R(t.id)},{default:i(()=>[o(h,{class:"p-3"},{default:i(()=>[e("div",Ae,[e("div",je,[e("div",ze,[e("h6",Me,l(t.name),1),x.value===t.id?(r(),d("i",Be)):I("",!0)]),e("p",Ne,l(t.description),1)])]),e("div",Te,[e("div",Fe,[e("span",Ie,l(t.format),1),e("small",Ue,l(t.fileSize),1)]),e("div",Pe,[s[12]||(s[12]=e("i",{class:"fa fa-building me-1"},null,-1)),b(" "+l(t.authority),1)]),e("div",$e,[s[13]||(s[13]=e("i",{class:"fa fa-calendar me-1"},null,-1)),b(" 更新："+l(t.lastUpdate),1)])]),e("button",{class:"btn btn-outline-theme btn-sm w-100",onClick:G(n=>E(t),["stop"])},s[14]||(s[14]=[e("i",{class:"fa fa-eye me-1"},null,-1),b(" 預覽模板 ")]),8,Ve)]),_:2},1024)]),_:2},1032,["class","onClick"])])),64))])]),_:1})]),_:1})])]),e("div",Oe,[e("div",Re,[o(g,null,{default:i(()=>[o(C,null,{default:i(()=>s[15]||(s[15]=[e("div",{class:"d-flex align-items-center"},[e("i",{class:"fa fa-cog me-2"}),e("h5",{class:"mb-0"},"下載設定")],-1)])),_:1,__:[15]}),o(h,null,{default:i(()=>[e("div",Xe,[e("div",Ee,[e("div",qe,[s[16]||(s[16]=e("label",{class:"form-label"},"自訂檔案名稱",-1)),z(e("input",{type:"text",class:"form-control","onUpdate:modelValue":s[0]||(s[0]=t=>y.value=t),placeholder:"留空則使用預設名稱"},null,512),[[H,y.value]]),e("div",Le," 預設名稱："+l(D.value),1)])]),e("div",We,[e("div",Ke,[s[19]||(s[19]=e("label",{class:"form-label"},"附加選項",-1)),e("div",Ye,[z(e("input",{class:"form-check-input",type:"checkbox","onUpdate:modelValue":s[1]||(s[1]=t=>M.value=t),id:"includeWatermark"},null,512),[[U,M.value]]),s[17]||(s[17]=e("label",{class:"form-check-label small",for:"includeWatermark"}," 包含浮水印 ",-1))]),e("div",Ge,[z(e("input",{class:"form-check-input",type:"checkbox","onUpdate:modelValue":s[2]||(s[2]=t=>B.value=t),id:"includeSignature"},null,512),[[U,B.value]]),s[18]||(s[18]=e("label",{class:"form-check-label small",for:"includeSignature"}," 包含簽名欄位 ",-1))])])])]),e("div",He,[e("div",Je,[s[20]||(s[20]=e("i",{class:"fa fa-info-circle me-1"},null,-1)),_.value?(r(),d("span",Qe," 已選擇："+l(_.value.name)+" ("+l(_.value.fileSize)+") ",1)):(r(),d("span",Ze,"請選擇模板"))]),e("button",{class:"btn btn-theme btn-lg",onClick:X,disabled:!T.value},[e("i",{class:F(["fa me-2",{"fa-spin fa-spinner":m.value,"fa-download":!m.value}])},null,2),b(" "+l(m.value?"處理中...":"下載表單"),1)],8,es)]),m.value?(r(),d("div",ss,[e("div",ts,[s[21]||(s[21]=e("span",{class:"small"},"正在生成文件...",-1)),e("span",ls,l(Math.round(f.value))+"%",1)]),e("div",as,[e("div",{class:"progress-bar progress-bar-striped progress-bar-animated",style:J({width:f.value+"%"})},null,4)])])):I("",!0)]),_:1})]),_:1})]),e("div",os,[o(g,null,{default:i(()=>[o(C,null,{default:i(()=>s[22]||(s[22]=[e("div",{class:"d-flex align-items-center"},[e("i",{class:"fa fa-history me-2"}),e("h5",{class:"mb-0"},"最近下載")],-1)])),_:1,__:[22]}),o(h,null,{default:i(()=>[v.value.length===0?(r(),d("div",is,s[23]||(s[23]=[e("i",{class:"fa fa-download fa-2x text-muted mb-2"},null,-1),e("p",{class:"text-muted small mb-0"},"尚無下載記錄",-1)]))):(r(),d("div",ns,[(r(!0),d(A,null,j(v.value,t=>(r(),d("div",{key:t.id,class:"mb-3"},[o(g,{class:"download-item"},{default:i(()=>[o(h,{class:"p-3"},{default:i(()=>[e("div",ds,[e("h6",rs,l(t.template),1),e("button",{class:"btn btn-outline-theme btn-sm",onClick:n=>q(t)},s[24]||(s[24]=[e("i",{class:"fa fa-download"},null,-1)]),8,cs)]),e("p",ms,l(t.fileName),1),e("div",us,[e("small",fs,l(t.downloadTime),1),e("small",vs,l(t.fileSize),1)])]),_:2},1024)]),_:2},1024)]))),128))]))]),_:1})]),_:1})])])])])]))}}),ys=Q(ps,[["__scopeId","data-v-cc5e42c0"]]);export{ys as default};
