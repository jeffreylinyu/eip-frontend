import{d as ce,r as k,k as N,w as ie,a as pe,B as le,f as o,p as M,l as e,A as re,e as i,m as C,I as Y,s as p,z as U,F as D,y as Q,v as u,Q as ge,J as se,V as de,_ as ue,j as ve,i as j,O as xe,P as we,a1 as Ce,D as me,L as _,x as ne,C as oe,q as fe,a2 as _e,a3 as he,g as $e,c as Ie,S as Te}from"./index-CB9Z8Gmd.js";import{f as Re}from"./format-DXaH7iKE.js";import{u as ke,C as be,a as ye}from"./company-Dv077Pgh.js";import{P as Pe}from"./ProjectForm-DIYrBlOJ.js";const Ne={class:"mb-3"},Se=["disabled"],Ee=["value"],Me={key:0,class:"invalid-feedback"},Ae={key:1,class:"form-text text-warning"},Le={class:"mb-3"},je=["disabled"],We={key:0,class:"invalid-feedback"},Oe={class:"form-text"},Ue={class:"mb-3"},Ve=["disabled"],qe={key:0,class:"invalid-feedback"},Be={class:"form-text"},ze={key:0,class:"alert alert-danger"},Ge={class:"mb-0 mt-2"},He=ce({__name:"WorkspaceFormModal",props:{show:{type:Boolean},workspace:{}},emits:["update:show","hide","submit"],setup(te,{emit:x}){const y=te,S=x,n=k({name:"",description:"",companyId:""}),c=ke(),P=k(!1),f=k({}),b=N(()=>!!y.workspace),g=N(()=>b.value?"編輯工作空間":"新增工作空間"),W=N(()=>b.value?"更新":"創建"),R=N(()=>c.activeCompanies),$=()=>{S("update:show",!1),S("hide")},h=()=>{var I;n.value={name:"",description:"",companyId:((I=R.value[0])==null?void 0:I.companyId)||""},f.value={}};ie(()=>y.workspace,I=>{I?n.value={name:I.name,description:I.description,companyId:I.companyId||""}:h()},{immediate:!0}),ie(()=>y.show,I=>{I&&(f.value={},!n.value.companyId&&R.value.length>0&&(n.value.companyId=R.value[0].companyId))});const z=()=>(f.value={},n.value.name.trim()?n.value.name.trim().length<2?f.value.name="工作空間名稱至少需要2個字符":n.value.name.trim().length>50&&(f.value.name="工作空間名稱不能超過50個字符"):f.value.name="工作空間名稱不能為空",n.value.companyId.trim()||(f.value.companyId="請選擇一個公司"),n.value.description.trim().length>200&&(f.value.description="工作空間描述不能超過200個字符"),Object.keys(f.value).length===0),E=async()=>{if(z()){P.value=!0;try{const I={name:n.value.name.trim(),description:n.value.description.trim(),companyId:n.value.companyId.trim()};S("submit",I)}catch(I){console.error("❌ 表單提交錯誤:",I)}finally{P.value=!1}}},A=()=>{E()},V=I=>{f.value[I]&&delete f.value[I]};return pe(()=>{c.initCompanies()}),(I,s)=>(o(),le(de,{show:y.show,title:g.value,icon:"fa fa-building",size:"lg","modal-id":"workspaceFormModal","confirm-text":W.value,"confirm-icon":"fa fa-save","is-loading":P.value,"loading-text":"處理中...",onHide:$,onConfirm:A},{body:M(()=>[e("form",{onSubmit:re(E,["prevent"])},[e("div",Ne,[s[8]||(s[8]=e("label",{for:"companyId",class:"form-label"},[p(" 所屬公司 "),e("span",{class:"text-danger"},"*")],-1)),Y(e("select",{id:"companyId",class:U(["form-select",{"is-invalid":f.value.companyId}]),"onUpdate:modelValue":s[0]||(s[0]=d=>n.value.companyId=d),onChange:s[1]||(s[1]=d=>V("companyId")),disabled:P.value},[s[6]||(s[6]=e("option",{value:""},"請選擇公司",-1)),(o(!0),i(D,null,Q(R.value,d=>(o(),i("option",{key:d.companyId,value:d.companyId},u(d.companyName)+" ("+u(d.companyCode)+") ",9,Ee))),128))],42,Se),[[ge,n.value.companyId]]),f.value.companyId?(o(),i("div",Me,u(f.value.companyId),1)):C("",!0),R.value.length===0?(o(),i("div",Ae,s[7]||(s[7]=[e("i",{class:"fa fa-exclamation-triangle me-1"},null,-1),p(" 目前沒有可用的公司，請先建立公司 ")]))):C("",!0)]),e("div",Le,[s[9]||(s[9]=e("label",{for:"workspaceName",class:"form-label"},[p(" 工作空間名稱 "),e("span",{class:"text-danger"},"*")],-1)),Y(e("input",{id:"workspaceName",type:"text",class:U(["form-control",{"is-invalid":f.value.name}]),"onUpdate:modelValue":s[2]||(s[2]=d=>n.value.name=d),onInput:s[3]||(s[3]=d=>V("name")),placeholder:"請輸入工作空間名稱",maxlength:"50",disabled:P.value},null,42,je),[[se,n.value.name]]),f.value.name?(o(),i("div",We,u(f.value.name),1)):C("",!0),e("div",Oe,u(n.value.name.length)+"/50 字符 ",1)]),e("div",Ue,[s[10]||(s[10]=e("label",{for:"workspaceDescription",class:"form-label"},"工作空間描述",-1)),Y(e("textarea",{id:"workspaceDescription",class:U(["form-control",{"is-invalid":f.value.description}]),"onUpdate:modelValue":s[4]||(s[4]=d=>n.value.description=d),onInput:s[5]||(s[5]=d=>V("description")),placeholder:"請輸入工作空間描述（選填）",rows:"3",maxlength:"200",disabled:P.value},null,42,Ve),[[se,n.value.description]]),f.value.description?(o(),i("div",qe,u(f.value.description),1)):C("",!0),e("div",Be,u(n.value.description.length)+"/200 字符 ",1)]),Object.keys(f.value).length>0?(o(),i("div",ze,[s[11]||(s[11]=e("i",{class:"fa fa-exclamation-triangle me-2"},null,-1)),s[12]||(s[12]=p(" 請修正以下錯誤： ")),e("ul",Ge,[(o(!0),i(D,null,Q(f.value,(d,w)=>(o(),i("li",{key:w},u(d),1))),128))])])):C("",!0)],32)]),_:1},8,["show","title","confirm-text","is-loading"]))}}),Ye=ue(He,[["__scopeId","data-v-99cb1239"]]),De={class:"d-flex align-items-center justify-content-between w-100"},Je={class:"modal-title"},Qe={class:"btn-group",role:"group"},Ke=ce({__name:"ProjectFormModal",props:{show:{type:Boolean},project:{}},emits:["update:show","hide","submit"],setup(te,{emit:x}){const y=te,S=x,n=ve(),c=k({project_name:"",contract_number:"",project_location:"",host_agency:"",supervision_unit:"",contractor_name:"",construction_period:"",project_amount:"",project_grade:"",original_contract_amount:"",current_contract_amount:"",project_category:"",funding_source:"",sign_date:"",start_date:"",completion_date:"",construction_confirm_date:"",construction_project_id:"",payment_method:"",advance_payment_ratio:"",retention_ratio:"",inspection_methods:[],segmented_acceptance:!1,partial_acceptance:!1,completion_acceptance:!1,insurance_policy_number:"",insurance_company:"",insurance_start_date:"",insurance_end_date:"",insurance_type:"",signLevel:[],workspaceId:""}),P=k(!1),f=k(null),b=N(()=>!!y.project),g=N(()=>b.value?"編輯工程項目":"新增工程項目"),W=N(()=>b.value?"更新":"創建"),R={complete:{project_name:"新北市蘆洲區社區公園改善計畫",contract_number:"CONTRACT-2024-001",project_location:"新北市蘆洲區中正路1號",host_agency:"新北市政府工務局",supervision_unit:"中興工程顧問股份有限公司",contractor_name:"中華工程股份有限公司",construction_period:"180天",project_amount:"7500000",project_grade:"甲等",original_contract_amount:"7000000",current_contract_amount:"7500000",project_category:"土木工程",funding_source:"一般預算",sign_date:"2024-05-01",start_date:"2024-06-01",completion_date:"2024-12-01",construction_confirm_date:"2024-05-15",construction_project_id:"CPID-001",payment_method:"分期付款",advance_payment_ratio:"30",retention_ratio:"5",inspection_methods:["分段驗收","竣工驗收"],segmented_acceptance:!0,partial_acceptance:!1,completion_acceptance:!0,insurance_policy_number:"INS-2024-001",insurance_company:"華南產物保險",insurance_start_date:"2024-06-01",insurance_end_date:"2025-06-01",insurance_type:"工程險",signLevel:[{level:1,title:"總監"},{level:2,title:"副總監"},{level:3,title:"監造工程師"}]},partial:{project_name:"台北市信義區道路改善工程",contract_number:"CONTRACT-2024-002",project_location:"台北市信義區信義路五段",host_agency:"台北市政府工務局",supervision_unit:"",contractor_name:"",construction_period:"120天",project_amount:"5000000",project_grade:"乙等",original_contract_amount:"5000000",current_contract_amount:"5000000",project_category:"道路工程",funding_source:"前瞻基礎建設計畫",sign_date:"2024-06-15",start_date:"2024-07-01",completion_date:"2024-11-01",construction_confirm_date:"",construction_project_id:"",payment_method:"工程款支付",advance_payment_ratio:"25",retention_ratio:"3",inspection_methods:["竣工驗收"],segmented_acceptance:!1,partial_acceptance:!1,completion_acceptance:!0,insurance_policy_number:"",insurance_company:"富邦產物保險",insurance_start_date:"2024-07-01",insurance_end_date:"2025-07-01",insurance_type:"雇主責任險",signLevel:[{level:1,title:"部長"},{level:2,title:"次長"}]},empty:{project_name:"",contract_number:"",project_location:"",host_agency:"",supervision_unit:"",contractor_name:"",construction_period:"",project_amount:"",project_grade:"",original_contract_amount:"",current_contract_amount:"",project_category:"",funding_source:"",sign_date:"",start_date:"",completion_date:"",construction_confirm_date:"",construction_project_id:"",payment_method:"",advance_payment_ratio:"",retention_ratio:"",inspection_methods:[],segmented_acceptance:!1,partial_acceptance:!1,completion_acceptance:!1,insurance_policy_number:"",insurance_company:"",insurance_start_date:"",insurance_end_date:"",insurance_type:"",signLevel:[]}},$=s=>{var w,L;c.value={...R[s],workspaceId:((w=n.currentWorkspace)==null?void 0:w.id)||((L=n.workspaces[0])==null?void 0:L.id)||""},alert(`已載入${s==="complete"?"完整測試資料":s==="partial"?"部分測試資料":"空測試資料"}！`)},h=()=>{S("update:show",!1),S("hide")},z=()=>{var s,d;c.value={project_name:"",contract_number:"",project_location:"",host_agency:"",supervision_unit:"",contractor_name:"",construction_period:"",project_amount:"",project_grade:"",original_contract_amount:"",current_contract_amount:"",project_category:"",funding_source:"",sign_date:"",start_date:"",completion_date:"",construction_confirm_date:"",construction_project_id:"",payment_method:"",advance_payment_ratio:"",retention_ratio:"",inspection_methods:[],segmented_acceptance:!1,partial_acceptance:!1,completion_acceptance:!1,insurance_policy_number:"",insurance_company:"",insurance_start_date:"",insurance_end_date:"",insurance_type:"",signLevel:[],workspaceId:((s=n.currentWorkspace)==null?void 0:s.id)||((d=n.workspaces[0])==null?void 0:d.id)||""}},E=s=>{try{c.value.project_name=s.name||"",c.value.contract_number=s.contractNumber||"",c.value.project_location=s.location||"",c.value.host_agency=s.hostAgency||"",c.value.supervision_unit=s.supervisionUnit||"",c.value.contractor_name=s.contractorName||"",c.value.construction_period=s.constructionPeriod||"",c.value.project_amount=s.budget||"",c.value.original_contract_amount=s.originalContractAmount||"",c.value.current_contract_amount=s.currentContractAmount||"";const d={A1:"甲等",A2:"甲等",B1:"乙等",B2:"乙等",C1:"丙等",C2:"丙等"};c.value.project_grade=d[s.projectGrade]||s.projectGrade||"",c.value.project_category=s.projectCategory||"";const w={中央政府:"一般預算",地方政府:"一般預算",前瞻基礎建設計畫:"前瞻基礎建設計畫",專案補助:"專案補助",特別預算:"特別預算"};c.value.funding_source=w[s.fundingSource]||s.fundingSource||"",c.value.sign_date=s.signDate?s.signDate.split("T")[0]:"",c.value.start_date=s.startDate?s.startDate.split("T")[0]:"",c.value.completion_date=s.endDate?s.endDate.split("T")[0]:"",c.value.construction_confirm_date=s.constructionConfirmDate?s.constructionConfirmDate.split("T")[0]:"",c.value.construction_project_id=s.constructionProjectId||"",c.value.payment_method=s.paymentMethod||"",c.value.advance_payment_ratio=s.advancePaymentRatio||"",c.value.retention_ratio=s.retentionRatio||"",c.value.inspection_methods=s.inspectionMethods||[],c.value.segmented_acceptance=s.segmentedAcceptance||!1,c.value.partial_acceptance=s.partialAcceptance||!1,c.value.completion_acceptance=s.completionAcceptance||!1,c.value.insurance_policy_number=s.insurancePolicyNumber||"",c.value.insurance_company=s.insuranceCompany||"",c.value.insurance_start_date=s.insuranceStartDate?s.insuranceStartDate.split("T")[0]:"",c.value.insurance_end_date=s.insuranceEndDate?s.insuranceEndDate.split("T")[0]:"",c.value.insurance_type=s.insuranceType||"",c.value.signLevel=s.signLevel||[],c.value.workspaceId=s.workspaceId||""}catch(d){console.error("❌ 映射工程項目資料失敗:",d)}},A=async s=>{if(s)try{const d=n.workspaceProjects.find(L=>L.id===s.id);if(d){E(d);return}await n.getProjectsByWorkspace(s.workspaceId);const w=n.workspaceProjects.find(L=>L.id===s.id);E(w||s)}catch(d){console.error("❌ 載入工程項目資料失敗:",d),E(s)}};ie(()=>y.project,async(s,d)=>{if(!(s&&d&&s.id===d.id))if(s&&s.id)try{await A(s)}catch(w){console.error("載入工程項目資料失敗:",w)}else s&&!s.id?c.value={...c.value,workspaceId:s.workspaceId||""}:z()},{immediate:!1}),ie(()=>y.show,s=>{if(s){const d=b.value?"edit":"create";console.log(`🔧 工程項目編輯器開啟 - 模式: ${d}`)}else z()});const V=async s=>{var d,w,L,Z,F;P.value=!0;try{const q=((d=y.project)==null?void 0:d.workspaceId)||((w=n.currentWorkspace)==null?void 0:w.id)||((L=n.workspaces[0])==null?void 0:L.id);if(!q)throw new Error("無法獲取工作空間 ID");const G=xe(s,q);let K,J;if((Z=y.project)!=null&&Z.id){K=await we(y.project.id,G);const ee=`eip-workspace-projects-${q}`;localStorage.removeItem(ee),await n.getProjectsByWorkspace(q);const X=n.workspaceProjects.find(B=>B.id===y.project.id);X?(J=X,n.setCurrentProject(X,!1)):J={...y.project,name:s.project_name,location:s.project_location,budget:s.project_amount,startDate:s.start_date,endDate:s.completion_date,managerName:s.contractor_name,description:`${s.project_category} - ${s.funding_source}`,contractNumber:s.contract_number,hostAgency:s.host_agency,supervisionUnit:s.supervision_unit,constructionPeriod:s.construction_period,projectGrade:s.project_grade,projectCategory:s.project_category,fundingSource:s.funding_source,paymentMethod:s.payment_method,advancePaymentRatio:s.advance_payment_ratio,retentionRatio:s.retention_ratio,inspectionMethods:s.inspection_methods,insurancePolicyNumber:s.insurance_policy_number,insuranceCompany:s.insurance_company,insuranceStartDate:s.insurance_start_date,insuranceEndDate:s.insurance_end_date,insuranceType:s.insurance_type,signLevel:s.signLevel}}else K=await Ce(G),J={id:K.constructionId,name:s.project_name,workspaceId:q,location:s.project_location,budget:s.project_amount,status:"PLANNING",startDate:s.start_date,endDate:s.completion_date,managerName:s.contractor_name,description:`${s.project_category} - ${s.funding_source}`,progress:0,contractNumber:s.contract_number,hostAgency:s.host_agency,supervisionUnit:s.supervision_unit,constructionPeriod:s.construction_period,projectGrade:s.project_grade,projectCategory:s.project_category,fundingSource:s.funding_source,paymentMethod:s.payment_method,advancePaymentRatio:s.advance_payment_ratio,retentionRatio:s.retention_ratio,inspectionMethods:s.inspection_methods,insurancePolicyNumber:s.insurance_policy_number,insuranceCompany:s.insurance_company,insuranceStartDate:s.insurance_start_date,insuranceEndDate:s.insurance_end_date,insuranceType:s.insurance_type,signLevel:s.signLevel};S("submit",J),h()}catch(q){console.error("❌ 工程項目操作失敗:",q);const G=(F=y.project)!=null&&F.id?"更新":"創建";alert(`工程項目${G}失敗：${q.message||"未知錯誤"}`)}finally{P.value=!1}},I=async()=>{f.value?f.value.handleSubmit():console.error("❌ 無法找到 ProjectForm 組件引用")};return(s,d)=>(o(),le(de,{show:y.show,title:g.value,icon:"fa fa-project-diagram",size:"xxl","modal-id":"projectFormModal","confirm-text":W.value,"confirm-icon":"fa fa-save","is-loading":P.value,"loading-text":"處理中...",onHide:h,onConfirm:I},{header:M(()=>[e("div",De,[e("div",null,[e("h5",Je,[d[4]||(d[4]=e("i",{class:"fa fa-project-diagram me-2"},null,-1)),p(" "+u(g.value),1)])]),e("div",Qe,[e("button",{type:"button",class:"btn btn-outline-success btn-sm",onClick:d[0]||(d[0]=w=>$("complete")),title:"載入完整測試資料"},d[5]||(d[5]=[e("i",{class:"fa fa-check-circle me-1"},null,-1),p(" 完整資料 ")])),e("button",{type:"button",class:"btn btn-outline-warning btn-sm",onClick:d[1]||(d[1]=w=>$("partial")),title:"載入部分測試資料（有錯誤）"},d[6]||(d[6]=[e("i",{class:"fa fa-exclamation-triangle me-1"},null,-1),p(" 部分資料 ")])),e("button",{type:"button",class:"btn btn-outline-danger btn-sm",onClick:d[2]||(d[2]=w=>$("empty")),title:"載入空測試資料（全部錯誤）"},d[7]||(d[7]=[e("i",{class:"fa fa-times-circle me-1"},null,-1),p(" 空資料 ")]))])])]),body:M(()=>[j(Pe,{ref_key:"projectFormRef",ref:f,modelValue:c.value,"onUpdate:modelValue":d[3]||(d[3]=w=>c.value=w),mode:b.value?"edit":"create","is-submitting":P.value,"show-submit-button":!1,"show-reset-button":!1,onSubmit:V,onReset:z},null,8,["modelValue","mode","is-submitting"])]),_:1},8,["show","title","confirm-text","is-loading"]))}}),Xe=ue(Ke,[["__scopeId","data-v-f47b9d47"]]),Ze={class:"workspace-company-management"},Fe={class:"d-flex align-items-center justify-content-between mb-4"},et={class:"mb-1"},tt={class:"d-flex align-items-center"},st={class:"company-roles-container mb-4"},at={class:"row mb-4"},nt={class:"col-md-6"},ot={class:"role-section h-100 d-flex flex-column"},lt={class:"d-flex align-items-center justify-content-between mb-3"},it={class:"flex-grow-1 d-flex flex-column"},rt={class:"d-flex align-items-center flex-grow-1"},dt={class:"flex-grow-1"},ct={class:"mb-1 fw-bold text-primary"},ut={class:"text-muted small mb-2"},mt={class:"d-flex align-items-center gap-2"},pt={class:"text-end"},vt={class:"text-muted small mb-2"},ft={key:1,class:"empty-state flex-grow-1 d-flex flex-column justify-content-center"},_t={class:"col-md-6"},bt={class:"role-section h-100 d-flex flex-column"},yt={class:"d-flex align-items-center justify-content-between mb-3"},gt={class:"flex-grow-1 d-flex flex-column"},kt={class:"d-flex align-items-center flex-grow-1"},xt={class:"flex-grow-1"},wt={class:"mb-1 fw-bold text-info"},Ct={class:"text-muted small mb-2"},ht={class:"d-flex align-items-center gap-2"},$t={class:"text-end"},It={class:"text-muted small mb-2"},Tt={key:1,class:"empty-state flex-grow-1 d-flex flex-column justify-content-center"},Rt={class:"role-section"},Pt={class:"d-flex align-items-center justify-content-between mb-3"},Nt={key:0,class:"third-party-grid"},St={class:"d-flex align-items-center"},Et={class:"flex-grow-1"},Mt={class:"mb-1 fw-bold text-success"},At={class:"text-muted small mb-2"},Lt={class:"d-flex align-items-center gap-2"},jt={class:"text-end"},Wt={class:"text-muted small mb-2"},Ot=["onClick"],Ut={key:1,class:"empty-state"},Vt={class:"pending-actions-container mb-4"},qt={class:"row"},Bt={class:"col-md-6"},zt={class:"d-flex align-items-center justify-content-between"},Gt={key:0,class:"badge bg-warning rounded-pill"},Ht={key:0,class:"text-center py-3"},Yt={key:1},Dt={class:"fw-600 small"},Jt={class:"text-muted",style:{"font-size":"0.75rem"}},Qt={class:"d-flex gap-1"},Kt={class:"col-md-6"},Xt={class:"d-flex align-items-center justify-content-between"},Zt={key:0,class:"badge bg-danger rounded-pill"},Ft={key:0,class:"text-center py-3"},es={key:1},ts={class:"fw-600 small"},ss={class:"text-muted",style:{"font-size":"0.75rem"}},as={class:"d-flex gap-1"},ns=["onClick"],os=["onClick"],ls={class:"mb-3"},is={class:"input-group"},rs=["disabled"],ds={key:0,class:"spinner-border spinner-border-sm me-1"},cs={key:1,class:"fa fa-search me-1"},us={key:0,class:"invalid-feedback d-block"},ms={key:0,class:"mb-3"},ps={class:"card border-success"},vs={class:"card-body py-2"},fs={class:"d-flex align-items-center"},_s={class:"flex-grow-1"},bs={class:"fw-600"},ys={class:"text-muted small"},gs={class:"text-muted small"},ks={class:"mb-3"},xs=["value","disabled"],ws={key:0},Cs={class:"mb-3"},hs={class:"d-flex justify-content-end gap-2"},$s=["disabled"],Is={class:"alert alert-warning"},Ts={class:"mb-3"},Rs={class:"mb-3"},Ps={class:"form-check"},Ns={class:"form-check"},Ss={key:0,class:"mb-3"},Es={class:"d-flex justify-content-end gap-2"},Ms=["disabled"],As=ce({__name:"WorkspaceCompanyManagement",props:{workspace:{}},emits:["back"],setup(te,{emit:x}){const y=te,S=x,n=ve();ke();const c=k(!1);k("companies");const P=k(!1),f=k(!1);k(!1);const b=k({companyCode:"",companyId:"",role:"",message:""}),g=k(null),W=k(!1),R=k(""),$=k({companyId:"",reason:"",requestType:"MUTUAL_AGREEMENT",customerServiceNote:""}),h=k(""),z=k(""),E=k(null);N(()=>{let l=n.workspaceCompanies;return h.value&&(l=l.filter(t=>t.companyName.toLowerCase().includes(h.value.toLowerCase())||t.companyUnifiedNumber.includes(h.value))),z.value&&(l=l.filter(t=>t.companyType===z.value)),l});const A=N(()=>{var l,t;return((l=y.workspace)==null?void 0:l.role)==="OWNER"||((t=y.workspace)==null?void 0:t.role)==="ADMIN"}),V=N(()=>{const l=n.workspaceCompanies.filter(t=>t.role==="MAIN_CONTRACTOR"&&t.status==="ACTIVE");return A.value&&l.length===0}),I=N(()=>{const l=n.workspaceCompanies.filter(t=>t.role==="SUPERVISOR"&&t.status==="ACTIVE");return A.value&&l.length===0}),s=N(()=>A.value),d=N(()=>[{value:"MAIN_CONTRACTOR",label:"主要承包商",disabled:!V.value},{value:"SUPERVISOR",label:"監造單位",disabled:!I.value},{value:"THIRD_PARTY",label:"第三方公司",disabled:!s.value}]),w=async()=>{if(y.workspace){c.value=!0;try{await Promise.all([n.loadWorkspaceCompanies(y.workspace.id),n.searchAvailableCompanies(y.workspace.id)])}catch(l){console.error("Failed to load data:",l)}finally{c.value=!1}}},L=l=>{b.value={companyCode:"",companyId:"",role:l||"",message:""},g.value=null,R.value="",P.value=!0},Z=()=>{P.value=!1,b.value={companyCode:"",companyId:"",role:"",message:""},g.value=null,R.value=""},F=async()=>{const l=b.value.companyCode.trim();if(!l){R.value="請輸入公司代碼",g.value=null;return}W.value=!0,R.value="";try{const t=await he.searchCompanyByCode(l);t?(g.value=t,b.value.companyId=t.companyId,R.value=""):(g.value=null,R.value="找不到此公司代碼，請確認代碼是否正確")}catch(t){console.error("Failed to search company:",t),R.value="搜索公司時發生錯誤，請稍後再試",g.value=null}finally{W.value=!1}},q=async()=>{if(!(!y.workspace||!b.value.companyId||!b.value.role))try{if(b.value.role==="MAIN_CONTRACTOR"&&!V.value)throw new Error("工作空間已有主要承包商，無法再邀請");if(b.value.role==="SUPERVISOR"&&!I.value)throw new Error("工作空間已有監造單位，無法再邀請");if(!A.value)throw new Error("您沒有邀請公司的權限");await n.inviteCompanyToWorkspace(y.workspace.id,{companyId:b.value.companyId,role:b.value.role,message:b.value.message}),Z(),await w()}catch(l){console.error("Failed to invite company:",l),alert(l instanceof Error?l.message:"邀請失敗")}},G=l=>{E.value=l,$.value={companyId:l.companyId,reason:"",requestType:"MUTUAL_AGREEMENT",customerServiceNote:""},f.value=!0},K=()=>{f.value=!1,E.value=null,$.value={companyId:"",reason:"",requestType:"MUTUAL_AGREEMENT",customerServiceNote:""}},J=async()=>{if(!(!y.workspace||!$.value.companyId||!$.value.reason))try{await n.requestRemoveCompany(y.workspace.id,$.value),K(),await w()}catch(l){console.error("Failed to request removal:",l),alert("請求移除失敗")}},ee=async(l,t)=>{try{await n.respondToCompanyInvite(l,t),await w()}catch(v){console.error("Failed to respond to invite:",v),alert("回應邀請失敗")}},X=async(l,t)=>{if(y.workspace)try{await n.respondToRemovalRequest(y.workspace.id,l,t),await w()}catch(v){console.error("Failed to respond to removal request:",v),alert("回應移除請求失敗")}},B=l=>{var t;return((t=be.find(v=>v.value===l))==null?void 0:t.label)||l},H=l=>{var t;return((t=be.find(v=>v.value===l))==null?void 0:t.color)||"secondary"},r=l=>{var t;return l?((t=ye.find(v=>v.value===l))==null?void 0:t.label)||l:""},a=l=>{var t;return l&&((t=ye.find(v=>v.value===l))==null?void 0:t.color)||"secondary"},T=l=>({MAIN_CONTRACTOR:"主要承包商",SUPERVISOR:"監造單位",THIRD_PARTY:"第三方公司"})[l]||l;return ie(()=>y.workspace,l=>{l&&w()},{immediate:!0}),pe(()=>{y.workspace&&w()}),(l,t)=>{var v;return o(),i("div",Ze,[e("div",Fe,[e("div",null,[e("h5",et,[t[19]||(t[19]=e("i",{class:"fa fa-building me-2"},null,-1)),p(" "+u((v=l.workspace)==null?void 0:v.name)+" - 公司管理 ",1)]),t[20]||(t[20]=e("p",{class:"text-muted mb-0"},"管理工作空間中的公司成員",-1))]),e("div",tt,[e("button",{class:"btn btn-outline-secondary me-2",onClick:t[0]||(t[0]=m=>S("back"))},t[21]||(t[21]=[e("i",{class:"fa fa-arrow-left me-1"},null,-1),p(" 返回 ")])),e("button",{class:"btn btn-theme",onClick:t[1]||(t[1]=m=>L())},t[22]||(t[22]=[e("i",{class:"fa fa-plus me-1"},null,-1),p(" 邀請公司 ")]))])]),e("div",st,[e("div",at,[e("div",nt,[e("div",ot,[e("div",lt,[t[24]||(t[24]=me('<div class="d-flex align-items-center" data-v-653d4fe5><div class="role-icon-wrapper me-3" data-v-653d4fe5><i class="fa fa-hard-hat" data-v-653d4fe5></i></div><div data-v-653d4fe5><h5 class="mb-0 fw-bold" data-v-653d4fe5>營造單位</h5><span class="badge border border-primary text-primary px-2 pt-5px pb-5px rounded fs-12px" data-v-653d4fe5>唯一</span></div></div>',1)),!_(n).mainContractor&&A.value?(o(),i("button",{key:0,class:"btn btn-primary btn-sm shadow-sm",onClick:t[2]||(t[2]=m=>L("MAIN_CONTRACTOR"))},t[23]||(t[23]=[e("i",{class:"fa fa-plus me-1"},null,-1),p(" 邀請營造單位 ")]))):C("",!0)]),e("div",it,[_(n).mainContractor?(o(),le(oe,{key:0,class:"company-card shadow-sm flex-grow-1"},{default:M(()=>[j(ne,{class:"py-4 h-100 d-flex flex-column"},{default:M(()=>[e("div",rt,[t[28]||(t[28]=e("div",{class:"company-avatar me-3"},[e("i",{class:"fa fa-building"})],-1)),e("div",dt,[e("h6",ct,u(_(n).mainContractor.companyName),1),e("p",ut,[t[25]||(t[25]=e("i",{class:"fa fa-id-card me-1"},null,-1)),p(" "+u(_(n).mainContractor.companyUnifiedNumber),1)]),e("div",mt,[e("span",{class:U(["badge border px-2 pt-5px pb-5px rounded fs-12px",`border-${H(_(n).mainContractor.companyType)} text-${H(_(n).mainContractor.companyType)}`])},u(B(_(n).mainContractor.companyType)),3),_(n).mainContractor.contractorLevel?(o(),i("span",{key:0,class:U(["badge border px-2 pt-5px pb-5px rounded fs-12px",`border-${a(_(n).mainContractor.contractorLevel)} text-${a(_(n).mainContractor.contractorLevel)}`])},u(r(_(n).mainContractor.contractorLevel)),3)):C("",!0)])]),e("div",pt,[e("div",vt,[t[26]||(t[26]=e("i",{class:"fa fa-calendar me-1"},null,-1)),p(" "+u(new Date(_(n).mainContractor.joinedAt).toLocaleDateString()),1)]),A.value?(o(),i("button",{key:0,class:"btn btn-sm btn-outline-danger",onClick:t[3]||(t[3]=m=>G(_(n).mainContractor)),title:"請求移除"},t[27]||(t[27]=[e("i",{class:"fa fa-times"},null,-1)]))):C("",!0)])])]),_:1})]),_:1})):(o(),i("div",ft,t[29]||(t[29]=[e("div",{class:"empty-icon"},[e("i",{class:"fa fa-hard-hat"})],-1),e("h6",{class:"text-muted"},"尚未邀請營造單位",-1),e("p",{class:"text-muted small"},"邀請營造單位來管理工程項目",-1)])))])])]),e("div",_t,[e("div",bt,[e("div",yt,[t[31]||(t[31]=me('<div class="d-flex align-items-center" data-v-653d4fe5><div class="role-icon-wrapper me-3 supervisor" data-v-653d4fe5><i class="fa fa-eye" data-v-653d4fe5></i></div><div data-v-653d4fe5><h5 class="mb-0 fw-bold" data-v-653d4fe5>監造單位</h5><span class="badge border border-info text-info px-2 pt-5px pb-5px rounded fs-12px" data-v-653d4fe5>唯一</span></div></div>',1)),!_(n).supervisor&&A.value?(o(),i("button",{key:0,class:"btn btn-info btn-sm shadow-sm",onClick:t[4]||(t[4]=m=>L("SUPERVISOR"))},t[30]||(t[30]=[e("i",{class:"fa fa-plus me-1"},null,-1),p(" 邀請監造單位 ")]))):C("",!0)]),e("div",gt,[_(n).supervisor?(o(),le(oe,{key:0,class:"company-card shadow-sm flex-grow-1"},{default:M(()=>[j(ne,{class:"py-4 h-100 d-flex flex-column"},{default:M(()=>[e("div",kt,[t[35]||(t[35]=e("div",{class:"company-avatar me-3 supervisor"},[e("i",{class:"fa fa-clipboard-check"})],-1)),e("div",xt,[e("h6",wt,u(_(n).supervisor.companyName),1),e("p",Ct,[t[32]||(t[32]=e("i",{class:"fa fa-id-card me-1"},null,-1)),p(" "+u(_(n).supervisor.companyUnifiedNumber),1)]),e("div",ht,[e("span",{class:U(["badge border px-2 pt-5px pb-5px rounded fs-12px",`border-${H(_(n).supervisor.companyType)} text-${H(_(n).supervisor.companyType)}`])},u(B(_(n).supervisor.companyType)),3)])]),e("div",$t,[e("div",It,[t[33]||(t[33]=e("i",{class:"fa fa-calendar me-1"},null,-1)),p(" "+u(new Date(_(n).supervisor.joinedAt).toLocaleDateString()),1)]),A.value?(o(),i("button",{key:0,class:"btn btn-sm btn-outline-danger",onClick:t[5]||(t[5]=m=>G(_(n).supervisor)),title:"請求移除"},t[34]||(t[34]=[e("i",{class:"fa fa-times"},null,-1)]))):C("",!0)])])]),_:1})]),_:1})):(o(),i("div",Tt,t[36]||(t[36]=[e("div",{class:"empty-icon supervisor"},[e("i",{class:"fa fa-eye"})],-1),e("h6",{class:"text-muted"},"尚未邀請監造單位",-1),e("p",{class:"text-muted small"},"邀請監造單位來監督工程品質",-1)])))])])])]),e("div",Rt,[e("div",Pt,[t[38]||(t[38]=me('<div class="d-flex align-items-center" data-v-653d4fe5><div class="role-icon-wrapper me-3 third-party" data-v-653d4fe5><i class="fa fa-users" data-v-653d4fe5></i></div><div data-v-653d4fe5><h5 class="mb-0 fw-bold" data-v-653d4fe5>第三方公司</h5><span class="badge border border-success text-success px-2 pt-5px pb-5px rounded fs-12px" data-v-653d4fe5>可多個</span></div></div>',1)),A.value?(o(),i("button",{key:0,class:"btn btn-success btn-sm shadow-sm",onClick:t[6]||(t[6]=m=>L("THIRD_PARTY"))},t[37]||(t[37]=[e("i",{class:"fa fa-plus me-1"},null,-1),p(" 邀請第三方公司 ")]))):C("",!0)]),_(n).thirdPartyCompanies.length>0?(o(),i("div",Nt,[(o(!0),i(D,null,Q(_(n).thirdPartyCompanies,m=>(o(),le(oe,{key:m.companyId,class:"company-card border-success shadow-sm"},{default:M(()=>[j(ne,{class:"py-3"},{default:M(()=>[e("div",St,[t[42]||(t[42]=e("div",{class:"company-avatar me-3 third-party"},[e("i",{class:"fa fa-handshake"})],-1)),e("div",Et,[e("h6",Mt,u(m.companyName),1),e("p",At,[t[39]||(t[39]=e("i",{class:"fa fa-id-card me-1"},null,-1)),p(" "+u(m.companyUnifiedNumber),1)]),e("div",Lt,[e("span",{class:U(["badge border px-2 pt-5px pb-5px rounded fs-12px",`border-${H(m.companyType)} text-${H(m.companyType)}`])},u(B(m.companyType)),3)])]),e("div",jt,[e("div",Wt,[t[40]||(t[40]=e("i",{class:"fa fa-calendar me-1"},null,-1)),p(" "+u(new Date(m.joinedAt).toLocaleDateString()),1)]),A.value?(o(),i("button",{key:0,class:"btn btn-sm btn-outline-danger",onClick:O=>G(m),title:"請求移除"},t[41]||(t[41]=[e("i",{class:"fa fa-times"},null,-1)]),8,Ot)):C("",!0)])])]),_:2},1024)]),_:2},1024))),128))])):(o(),i("div",Ut,t[43]||(t[43]=[e("div",{class:"empty-icon third-party"},[e("i",{class:"fa fa-users"})],-1),e("h6",{class:"text-muted"},"尚未邀請第三方公司",-1),e("p",{class:"text-muted small"},"邀請第三方公司來協助工程項目",-1)])))])]),e("div",Vt,[e("div",qt,[e("div",Bt,[j(oe,{class:"h-100"},{default:M(()=>[j(fe,null,{default:M(()=>[e("div",zt,[t[44]||(t[44]=e("h6",{class:"mb-0"},[e("i",{class:"fa fa-envelope me-2"}),p(" 待處理邀請 ")],-1)),_(n).pendingInvites.length>0?(o(),i("span",Gt,u(_(n).pendingInvites.length),1)):C("",!0)])]),_:1}),j(ne,null,{default:M(()=>[_(n).pendingInvites.length===0?(o(),i("div",Ht,t[45]||(t[45]=[e("i",{class:"fa fa-envelope fa-2x text-muted mb-2"},null,-1),e("p",{class:"text-muted mb-0 small"},"暫無待處理邀請",-1)]))):(o(),i("div",Yt,[(o(!0),i(D,null,Q(_(n).pendingInvites,m=>(o(),i("div",{key:m.companyId,class:"d-flex align-items-center justify-content-between py-2 border-bottom"},[e("div",null,[e("div",Dt,u(m.companyName),1),e("div",Jt,u(T(m.role)),1)]),e("div",Qt,[e("button",{class:"btn btn-sm btn-success",onClick:t[7]||(t[7]=O=>ee(l.workspace.id,"ACCEPT")),title:"接受"},t[46]||(t[46]=[e("i",{class:"fa fa-check"},null,-1)])),e("button",{class:"btn btn-sm btn-danger",onClick:t[8]||(t[8]=O=>ee(l.workspace.id,"REJECT")),title:"拒絕"},t[47]||(t[47]=[e("i",{class:"fa fa-times"},null,-1)]))])]))),128))]))]),_:1})]),_:1})]),e("div",Kt,[j(oe,{class:"h-100"},{default:M(()=>[j(fe,null,{default:M(()=>[e("div",Xt,[t[48]||(t[48]=e("h6",{class:"mb-0"},[e("i",{class:"fa fa-times-circle me-2"}),p(" 移除請求 ")],-1)),_(n).pendingRemovalRequests.length>0?(o(),i("span",Zt,u(_(n).pendingRemovalRequests.length),1)):C("",!0)])]),_:1}),j(ne,null,{default:M(()=>[_(n).pendingRemovalRequests.length===0?(o(),i("div",Ft,t[49]||(t[49]=[e("i",{class:"fa fa-times-circle fa-2x text-muted mb-2"},null,-1),e("p",{class:"text-muted mb-0 small"},"暫無移除請求",-1)]))):(o(),i("div",es,[(o(!0),i(D,null,Q(_(n).pendingRemovalRequests,m=>(o(),i("div",{key:m.id,class:"d-flex align-items-center justify-content-between py-2 border-bottom"},[e("div",null,[e("div",ts,u(m.companyName),1),e("div",ss,u(m.reason),1)]),e("div",as,[e("button",{class:"btn btn-sm btn-success",onClick:O=>X(m.id,"APPROVE"),title:"同意"},t[50]||(t[50]=[e("i",{class:"fa fa-check"},null,-1)]),8,ns),e("button",{class:"btn btn-sm btn-danger",onClick:O=>X(m.id,"REJECT"),title:"拒絕"},t[51]||(t[51]=[e("i",{class:"fa fa-times"},null,-1)]),8,os)])]))),128))]))]),_:1})]),_:1})])])]),j(de,{show:P.value,"onUpdate:show":t[13]||(t[13]=m=>P.value=m),title:"邀請公司加入工作空間",size:"lg"},{default:M(()=>[e("form",{onSubmit:re(q,["prevent"])},[e("div",ls,[t[53]||(t[53]=e("label",{class:"form-label"},[p("公司代碼 "),e("span",{class:"text-danger"},"*")],-1)),e("div",is,[Y(e("input",{"onUpdate:modelValue":t[9]||(t[9]=m=>b.value.companyCode=m),type:"text",class:U(["form-control",{"is-invalid":R.value}]),placeholder:"請輸入公司代碼",onInput:t[10]||(t[10]=m=>{R.value="",g.value=null}),required:""},null,34),[[se,b.value.companyCode]]),e("button",{type:"button",class:"btn btn-outline-primary",onClick:F,disabled:W.value||!b.value.companyCode.trim()},[W.value?(o(),i("span",ds)):(o(),i("i",cs)),t[52]||(t[52]=p(" 搜索 "))],8,rs)]),R.value?(o(),i("div",us,u(R.value),1)):C("",!0),t[54]||(t[54]=e("div",{class:"form-text"}," 請輸入要邀請公司在系統中的唯一代碼 ",-1))]),g.value?(o(),i("div",ms,[t[55]||(t[55]=e("label",{class:"form-label"},"公司信息",-1)),e("div",ps,[e("div",vs,[e("div",fs,[e("div",_s,[e("div",bs,u(g.value.companyName),1),e("div",ys," 公司代碼："+u(b.value.companyCode),1),e("div",gs," 統一編號："+u(g.value.companyUnifiedNumber),1)]),e("div",null,[e("span",{class:U(["badge border px-2 pt-5px pb-5px rounded fs-12px",`border-${H(g.value.companyType)} text-${H(g.value.companyType)}`])},u(B(g.value.companyType)),3),g.value.contractorLevel?(o(),i("span",{key:0,class:U(["badge border px-2 pt-5px pb-5px rounded fs-12px ms-1",`border-${a(g.value.contractorLevel)} text-${a(g.value.contractorLevel)}`])},u(r(g.value.contractorLevel)),3)):C("",!0)])])])])])):C("",!0),e("div",ks,[t[57]||(t[57]=e("label",{class:"form-label"},[p("公司角色 "),e("span",{class:"text-danger"},"*")],-1)),Y(e("select",{"onUpdate:modelValue":t[11]||(t[11]=m=>b.value.role=m),class:"form-select",required:""},[t[56]||(t[56]=e("option",{value:""},"請選擇角色",-1)),(o(!0),i(D,null,Q(d.value,m=>(o(),i("option",{key:m.value,value:m.value,disabled:m.disabled},[p(u(m.label)+" ",1),m.disabled?(o(),i("span",ws," (已有此角色公司)")):C("",!0)],8,xs))),128))],512),[[ge,b.value.role]]),t[58]||(t[58]=e("div",{class:"form-text"},[e("ul",{class:"mb-0 small text-muted"},[e("li",null,"主要承包商：每個工作空間只能有一間"),e("li",null,"監造單位：每個工作空間只能有一間"),e("li",null,"第三方公司：可以邀請多間")])],-1))]),e("div",Cs,[t[59]||(t[59]=e("label",{class:"form-label"},"邀請訊息",-1)),Y(e("textarea",{"onUpdate:modelValue":t[12]||(t[12]=m=>b.value.message=m),class:"form-control",rows:"3",placeholder:"輸入邀請訊息（選填）"},null,512),[[se,b.value.message]])]),e("div",hs,[e("button",{type:"button",class:"btn btn-secondary",onClick:Z}," 取消 "),e("button",{type:"submit",class:"btn btn-theme",disabled:!g.value||!b.value.role},t[60]||(t[60]=[e("i",{class:"fa fa-paper-plane me-1"},null,-1),p(" 發送邀請 ")]),8,$s)])],32)]),_:1},8,["show"]),j(de,{show:f.value,"onUpdate:show":t[18]||(t[18]=m=>f.value=m),title:"請求移除公司",size:"lg"},{default:M(()=>{var m;return[e("form",{onSubmit:re(J,["prevent"])},[e("div",Is,[t[61]||(t[61]=e("i",{class:"fa fa-exclamation-triangle me-2"},null,-1)),p(" 您正在請求移除公司「"+u((m=E.value)==null?void 0:m.companyName)+"」 ",1)]),e("div",Ts,[t[62]||(t[62]=e("label",{class:"form-label"},[p("移除原因 "),e("span",{class:"text-danger"},"*")],-1)),Y(e("textarea",{"onUpdate:modelValue":t[14]||(t[14]=O=>$.value.reason=O),class:"form-control",rows:"3",placeholder:"請詳細說明移除原因",required:""},null,512),[[se,$.value.reason]])]),e("div",Rs,[t[65]||(t[65]=e("label",{class:"form-label"},[p("處理方式 "),e("span",{class:"text-danger"},"*")],-1)),e("div",Ps,[Y(e("input",{id:"mutual-agreement","onUpdate:modelValue":t[15]||(t[15]=O=>$.value.requestType=O),class:"form-check-input",type:"radio",value:"MUTUAL_AGREEMENT"},null,512),[[_e,$.value.requestType]]),t[63]||(t[63]=e("label",{class:"form-check-label",for:"mutual-agreement"},[p(" 雙方協議 "),e("div",{class:"form-text"},"需要對方公司同意才能完成移除")],-1))]),e("div",Ns,[Y(e("input",{id:"customer-service","onUpdate:modelValue":t[16]||(t[16]=O=>$.value.requestType=O),class:"form-check-input",type:"radio",value:"CUSTOMER_SERVICE"},null,512),[[_e,$.value.requestType]]),t[64]||(t[64]=e("label",{class:"form-check-label",for:"customer-service"},[p(" 客服處理 "),e("div",{class:"form-text"},"由客服團隊介入處理移除請求")],-1))])]),$.value.requestType==="CUSTOMER_SERVICE"?(o(),i("div",Ss,[t[66]||(t[66]=e("label",{class:"form-label"},"客服備註",-1)),Y(e("textarea",{"onUpdate:modelValue":t[17]||(t[17]=O=>$.value.customerServiceNote=O),class:"form-control",rows:"2",placeholder:"提供給客服的額外說明"},null,512),[[se,$.value.customerServiceNote]])])):C("",!0),e("div",Es,[e("button",{type:"button",class:"btn btn-secondary",onClick:K}," 取消 "),e("button",{type:"submit",class:"btn btn-danger",disabled:!$.value.reason},t[67]||(t[67]=[e("i",{class:"fa fa-paper-plane me-1"},null,-1),p(" 提交移除請求 ")]),8,Ms)])],32)]}),_:1},8,["show"])])}}}),Ls=ue(As,[["__scopeId","data-v-653d4fe5"]]),js={class:"container-fluid"},Ws={class:"row"},Os={class:"col-12"},Us={class:"mb-3"},Vs={key:0,class:"text-center py-4"},qs={key:1,class:"text-center py-5"},Bs={key:2},zs={key:3,class:"workspace-split-layout"},Gs={class:"workspace-common-header"},Hs={class:"row g-0"},Ys={class:"col-md-8"},Ds={key:0,class:"workspace-projects-header"},Js={class:"workspace-projects-title"},Qs={class:"mb-0"},Ks={class:"workspace-projects-actions"},Xs={class:"row g-0 h-100"},Zs={class:"col-md-4 workspace-sidebar"},Fs={class:"workspace-list-container"},ea={class:"workspace-list-scroll"},ta=["onClick"],sa={class:"workspace-item-content"},aa={key:0,class:"workspace-loading-overlay"},na={class:"workspace-item-header"},oa={class:"workspace-name-compact"},la=["onClick","disabled"],ia=["onClick","disabled"],ra=["onClick","disabled"],da={class:"workspace-description-compact text-muted mb-2"},ca={class:"workspace-stats"},ua={class:"stat-item"},ma={class:"stat-item"},pa={class:"stat-item"},va={class:"workspace-role"},fa={class:"badge border border-primary text-primary px-2 pt-5px pb-5px rounded fs-12px d-inline-flex align-items-center"},_a={class:"col-md-8 project-detail-panel"},ba={class:"project-detail-container"},ya={key:0,class:"workspace-switching-loading"},ga={key:1,class:"project-detail-content"},ka={key:0,class:"project-grid-full"},xa=["onClick"],wa={class:"project-card-header-full"},Ca={class:"project-title-section"},ha={class:"project-title-full"},$a={class:"project-location-full"},Ia={key:0,class:"project-actions-full"},Ta={class:"right-actions"},Ra=["onClick"],Pa=["onClick"],Na={class:"project-status-full d-flex align-items-center gap-2"},Sa={key:0,class:"current-project-badge"},Ea={class:"project-info-full"},Ma={class:"info-item-full"},Aa={class:"info-value-full"},La={class:"info-item-full"},ja={class:"info-value-full"},Wa={class:"project-progress-full"},Oa={class:"progress-header-full"},Ua={class:"progress-percentage-full"},Va={class:"progress-bar-full"},qa={key:1,class:"project-empty-state"},Ba={class:"empty-state-content"},za=["onClick"],Ga={key:2,class:"workspace-select-prompt"},Ha=ce({__name:"WorkspaceManagement",setup(te){const x=ve(),{proxy:y}=$e(),S=k(new Set),n=k(!1),c=k(!1),P=k(null),f=k(!1),b=k(!1),g=k(null),W=k(null),R=k(!1),$=k(null),h=N(()=>x.workspaces.map(r=>{const a=x.workspaceProjects.filter(t=>t.workspaceId===r.id),T=a.filter(t=>t.status==="IN_PROGRESS").length,l=a.filter(t=>t.status==="COMPLETED").length;return{...r,projects:a,projectCount:a.length,activeProjectCount:T,completedProjectCount:l}})),z=async r=>{if(S.value.has(r))return;S.value.clear(),S.value.add(r);const a=h.value.find(T=>T.id===r);if(!(a&&a.projects&&a.projects.length>0)){c.value=!0,P.value=r;try{await x.getProjectsByWorkspace(r)}catch{}finally{c.value=!1,P.value=null}}},E=r=>S.value.has(r),A=r=>r.role==="OWNER"||r.role==="ADMIN",V=r=>r.role!=="VIEWER",I=()=>{g.value=null,f.value=!0},s=(r,a)=>{a.stopPropagation(),g.value={...r},f.value=!0},d=()=>{f.value=!1,g.value=null},w=async r=>{try{g.value?await x.updateWorkspace(g.value.id,r):await x.addWorkspace(r),d(),await B()}catch(a){console.error("保存工作空間失敗:",a),alert("保存工作空間失敗，請稍後再試")}},L=async(r,a)=>{if(a.stopPropagation(),window.confirm(`確定要刪除工作空間「${r.name}」嗎？此操作無法撤銷。`))try{await x.removeWorkspace(r.id),await B()}catch(l){console.error("刪除工作空間失敗:",l),alert("刪除工作空間失敗，請稍後再試")}},Z=(r,a)=>{a.stopPropagation(),W.value={...r},b.value=!0},F=()=>{b.value=!1,W.value=null},q=async r=>{try{W.value?x.updateProject(W.value.id,r):x.addProject(r),F(),await B()}catch(a){console.error("保存項目失敗:",a),alert("保存項目失敗，請稍後再試")}},G=async(r,a)=>{if(a.stopPropagation(),window.confirm(`確定要刪除工程項目「${r.name}」嗎？此操作無法撤銷。`))try{x.removeProject(r.id),await B()}catch(l){console.error("刪除工程項目失敗:",l),alert("刪除工程項目失敗，請稍後再試")}},K=(r,a)=>{a.stopPropagation();try{x.setCurrentProject(r),y.$toast.success(`已切換至工程項目：${r.name}`)}catch(T){console.error("設定目前項目失敗:",T),y.$toast.error("切換工程項目失敗")}},J=(r,a)=>{a.stopPropagation(),W.value=null,b.value=!0},ee=(r,a)=>{a.stopPropagation(),$.value=r,R.value=!0},X=()=>{R.value=!1,$.value=null},B=async()=>{n.value=!0;try{x.clearAllCache(),await x.initWorkspaces()}catch(r){console.error("Failed to refresh data:",r)}finally{n.value=!1}},H=r=>({PLANNING:"規劃中",IN_PROGRESS:"進行中",COMPLETED:"已完成",SUSPENDED:"暫停"})[r]||r;return N(()=>h.value.length),N(()=>h.value.filter(r=>r.role==="OWNER").length),N(()=>h.value.filter(r=>r.role==="ADMIN").length),N(()=>h.value.reduce((r,a)=>{var T;return r+(((T=a.projects)==null?void 0:T.length)||0)},0)),N(()=>h.value.reduce((r,a)=>{var T;return r+(((T=a.projects)==null?void 0:T.filter(l=>l.status==="IN_PROGRESS").length)||0)},0)),N(()=>h.value.reduce((r,a)=>{var T;return r+(((T=a.projects)==null?void 0:T.filter(l=>l.status==="COMPLETED").length)||0)},0)),pe(async()=>{if(!x.isInitialized&&x.workspaces.length===0&&!x.isLoading&&await x.initWorkspaces(),x.currentWorkspace&&h.value.length>0){const r=h.value.find(a=>{var T;return a.id===((T=x.currentWorkspace)==null?void 0:T.id)});r&&(S.value.clear(),S.value.add(r.id))}}),(r,a)=>{var l;const T=Ie("PageHeader");return o(),i(D,null,[e("div",js,[e("div",Ws,[e("div",Os,[e("div",Us,[j(T,{title:"工作空間管理",icon:"fa fa-sitemap",breadcrumbs:[{text:"工作空間管理",active:!0}],actions:[]})]),_(x).isLoading?(o(),i("div",Vs,a[5]||(a[5]=[e("div",{class:"spinner-border text-theme",role:"status"},[e("span",{class:"visually-hidden"},"載入中...")],-1),e("div",{class:"mt-2 text-muted"},"載入工作空間資料中...",-1)]))):h.value.length===0?(o(),i("div",qs,[a[7]||(a[7]=e("div",{class:"mb-3"},[e("i",{class:"fa fa-building fa-3x text-muted"})],-1)),a[8]||(a[8]=e("h5",{class:"text-muted mb-2"},"尚未建立任何工作空間",-1)),a[9]||(a[9]=e("p",{class:"text-muted mb-3"},"開始建立您的第一個工作空間",-1)),e("button",{class:"btn btn-theme",onClick:I},a[6]||(a[6]=[e("i",{class:"fa fa-plus me-2"},null,-1),p(" 新增工作空間 ")]))])):C("",!0),R.value?(o(),i("div",Bs,[j(Ls,{workspace:$.value,onBack:X},null,8,["workspace"])])):!_(x).isLoading&&h.value.length>0?(o(),i("div",zs,[e("div",Gs,[e("div",Hs,[e("div",{class:"col-md-4"},[e("div",{class:"workspace-list-header"},[e("div",{class:"d-flex justify-content-between align-items-center"},[a[11]||(a[11]=e("div",null,[e("h6",{class:"mb-0"},[e("i",{class:"fa fa-sitemap me-2"}),p(" 工作空間列表 ")])],-1)),e("button",{class:"btn btn-theme",onClick:I,title:"新增工作空間"},a[10]||(a[10]=[e("i",{class:"fa fa-plus me-1"},null,-1),p(" 新增工作空間 ")]))])])]),e("div",Ys,[S.value.size>0?(o(),i("div",Ds,[e("div",Js,[e("h5",Qs,[a[12]||(a[12]=e("i",{class:"fa fa-folder-open me-2"},null,-1)),p(" "+u((l=h.value.find(t=>E(t.id)))==null?void 0:l.name),1)])]),e("div",Ks,[V(h.value.find(t=>E(t.id)))?(o(),i("button",{key:0,class:"btn btn-theme me-2",onClick:a[0]||(a[0]=t=>J(h.value.find(v=>E(v.id)),t))},a[13]||(a[13]=[e("i",{class:"fa fa-plus me-1"},null,-1),p(" 新增項目 ")]))):C("",!0),e("button",{class:"btn btn-warning d-flex align-items-center",onClick:a[1]||(a[1]=t=>ee(h.value.find(v=>E(v.id)),t)),title:"管理公司成員與權限"},a[14]||(a[14]=[e("i",{class:"fa fa-building me-1"},null,-1),p(" 公司管理 "),e("i",{class:"fa fa-star ms-1",style:{"font-size":"0.7rem"}},null,-1)]))])])):C("",!0)])])]),e("div",Xs,[e("div",Zs,[e("div",Fs,[e("div",ea,[(o(!0),i(D,null,Q(h.value,t=>(o(),i("div",{key:t.id,class:U(["workspace-item-compact",{active:E(t.id),loading:P.value===t.id}]),onClick:v=>z(t.id)},[e("div",sa,[P.value===t.id?(o(),i("div",aa,a[15]||(a[15]=[e("div",{class:"workspace-loading-content"},[e("div",{class:"spinner-border spinner-border-sm text-theme me-2",role:"status"},[e("span",{class:"visually-hidden"},"載入中...")]),e("span",{class:"loading-text"},"載入工程項目中...")],-1)]))):C("",!0),e("div",na,[e("h6",oa,u(t.name),1),A(t)?(o(),i("div",{key:0,class:"workspace-item-actions",onClick:a[2]||(a[2]=re(()=>{},["stop"]))},[e("button",{class:"btn btn-sm btn-outline-warning me-1",onClick:v=>ee(t,v),title:"管理公司成員與權限",disabled:c.value},a[16]||(a[16]=[e("i",{class:"fa fa-building"},null,-1)]),8,la),e("button",{class:"btn btn-sm btn-outline-primary me-1",onClick:v=>s(t,v),title:"編輯工作空間",disabled:c.value},a[17]||(a[17]=[e("i",{class:"fa fa-edit"},null,-1)]),8,ia),e("button",{class:"btn btn-sm btn-outline-danger",onClick:v=>L(t,v),title:"刪除工作空間",disabled:c.value},a[18]||(a[18]=[e("i",{class:"fa fa-trash"},null,-1)]),8,ra)])):C("",!0)]),e("p",da,u(t.description),1),e("div",ca,[e("span",ua,[a[19]||(a[19]=e("i",{class:"fa fa-project-diagram text-primary"},null,-1)),p(" "+u(t.projectCount),1)]),e("span",ma,[a[20]||(a[20]=e("i",{class:"fa fa-play text-success"},null,-1)),p(" "+u(t.activeProjectCount),1)]),e("span",pa,[a[21]||(a[21]=e("i",{class:"fa fa-check text-info"},null,-1)),p(" "+u(t.completedProjectCount),1)])]),e("div",va,[e("span",fa,[a[22]||(a[22]=e("i",{class:"fa fa-crown me-1"},null,-1)),p(" "+u(t.role),1)])])])],10,ta))),128))])])]),e("div",_a,[e("div",ba,[c.value?(o(),i("div",ya,a[23]||(a[23]=[e("div",{class:"switching-loading-content"},[e("div",{class:"spinner-border text-theme mb-3",role:"status"},[e("span",{class:"visually-hidden"},"載入中...")]),e("h6",{class:"text-muted mb-2"},"正在載入工作空間項目"),e("p",{class:"text-muted"},"請稍候...")],-1)]))):S.value.size>0?(o(),i("div",ga,[(o(!0),i(D,null,Q(h.value.filter(t=>E(t.id)),t=>(o(),i("div",{key:t.id,class:"workspace-projects-section"},[t.projects.length>0?(o(),i("div",ka,[(o(!0),i(D,null,Q(t.projects,v=>{var m,O;return o(),i("div",{key:v.id,class:U(["project-card-full",{"current-project":((m=_(x).currentProject)==null?void 0:m.id)===v.id}]),onClick:ae=>K(v,ae)},[e("div",wa,[e("div",Ca,[e("h6",ha,u(v.name),1),e("div",$a,[a[24]||(a[24]=e("i",{class:"fa fa-map-marker-alt text-danger"},null,-1)),e("span",null,u(v.location),1)])]),V(t)?(o(),i("div",Ia,[e("div",Ta,[e("button",{class:"btn btn-sm btn-outline-primary me-1",onClick:ae=>Z(v,ae),title:"編輯工程項目"},a[25]||(a[25]=[e("i",{class:"fa fa-edit me-1"},null,-1),p(" 編輯 ")]),8,Ra),e("button",{class:"btn btn-sm btn-outline-danger",onClick:ae=>G(v,ae),title:"刪除工程項目"},a[26]||(a[26]=[e("i",{class:"fa fa-trash"},null,-1)]),8,Pa)])])):C("",!0)]),e("div",Na,[e("span",{class:U(`status-badge-full status-${v.status.toLowerCase()}`)},u(H(v.status)),3),((O=_(x).currentProject)==null?void 0:O.id)===v.id?(o(),i("span",Sa,a[27]||(a[27]=[e("span",{class:"badge border border-theme text-theme px-2 pt-5px pb-5px rounded fs-12px d-inline-flex align-items-center"},[e("i",{class:"fa fa-check me-1"}),p(" 目前項目 ")],-1)]))):C("",!0)]),e("div",Ea,[e("div",Ma,[a[28]||(a[28]=e("i",{class:"fa fa-dollar-sign text-success"},null,-1)),a[29]||(a[29]=e("span",{class:"info-label-full"},"預算",-1)),e("span",Aa,u(_(Re)(v.budget)),1)]),e("div",La,[a[30]||(a[30]=e("i",{class:"fa fa-calendar text-primary"},null,-1)),a[31]||(a[31]=e("span",{class:"info-label-full"},"工期",-1)),e("span",ja,u(v.startDate)+" - "+u(v.endDate),1)])]),e("div",Wa,[e("div",Oa,[a[32]||(a[32]=e("span",{class:"progress-label-full"},"進度",-1)),e("span",Ua,u(v.progress)+"%",1)]),e("div",Va,[e("div",{class:"progress-fill-full",style:Te({width:v.progress+"%"})},null,4)])])],10,xa)}),128))])):(o(),i("div",qa,[e("div",Ba,[a[34]||(a[34]=e("i",{class:"fa fa-project-diagram fa-3x text-muted mb-3"},null,-1)),a[35]||(a[35]=e("h6",{class:"text-muted mb-2"},"此工作空間尚未建立任何工程項目",-1)),a[36]||(a[36]=e("p",{class:"text-muted mb-3"},"開始建立您的第一個工程項目",-1)),V(t)?(o(),i("button",{key:0,class:"btn btn-theme",onClick:v=>J(t,v)},a[33]||(a[33]=[e("i",{class:"fa fa-plus me-1"},null,-1),p(" 建立第一個項目 ")]),8,za)):C("",!0)])]))]))),128))])):(o(),i("div",Ga,a[37]||(a[37]=[e("div",{class:"select-prompt-content"},[e("i",{class:"fa fa-mouse-pointer fa-3x text-muted mb-3"}),e("h5",{class:"text-muted mb-2"},"選擇工作空間"),e("p",{class:"text-muted"},"點擊左側的工作空間來查看其工程項目")],-1)])))])])])])):C("",!0)])])]),j(Ye,{show:f.value,"onUpdate:show":a[3]||(a[3]=t=>f.value=t),workspace:g.value,onHide:d,onSubmit:w},null,8,["show","workspace"]),j(Xe,{show:b.value,"onUpdate:show":a[4]||(a[4]=t=>b.value=t),project:W.value,onHide:F,onSubmit:q},null,8,["show","project"])],64)}}}),Ka=ue(Ha,[["__scopeId","data-v-5416ec6a"]]);export{Ka as default};
