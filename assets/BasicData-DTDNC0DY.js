import{d as T,g as R,j as V,r as o,w as A,a as E,b as O,N as I,c as J,e as b,f as w,i as D,l as r,m as L,s as p,z as U,v as W,F as $,O as M,P as z,_ as H}from"./index-DpB6-9r-.js";import{P as j}from"./ProjectForm-BFEj1EYo.js";import"./format-DXaH7iKE.js";const q={class:"row gx-4"},G={class:"col-lg-12"},K={class:"d-flex justify-content-end gap-2"},Q=["disabled"],X=["disabled"],Y={key:0,class:"alert alert-warning mt-3",role:"alert"},Z=T({__name:"BasicData",setup(ee){const{proxy:l}=R(),a=V(),c=o({project_name:"",contract_number:"",project_location:"",host_agency:"",supervision_unit:"",contractor_name:"",construction_period:"",project_amount:"",project_grade:"",current_contract_amount:"",project_category:"",funding_source:"",sign_date:"",start_date:"",completion_date:"",construction_confirm_date:"",construction_project_id:"",payment_method:"",advance_payment_ratio:"",retention_ratio:"",inspection_methods:[],segmented_acceptance:!1,partial_acceptance:!1,completion_acceptance:!1,insurance_policy_number:"",insurance_company:"",insurance_start_date:"",insurance_end_date:"",insurance_type:"",signLevel:[]}),f=o({}),s=o(!1),i=o(!1),g=o(!1);o(""),o([{text:"土木工程"},{text:"建築工程"}]),o(""),o([{text:"甲等"},{text:"乙等"}]),o(""),o([{text:"交通部"}]),o(""),o([]),o([{text:"道路工程"},{text:"橋梁工程"},{text:"隧道工程"}]);const u=o(null),v=async e=>{if(!e)return;const t=a.workspaceProjects.find(n=>n.id===e.id);t?d(t):await P(),f.value=JSON.parse(JSON.stringify(c.value)),i.value=!1};A(()=>a.currentProject,async(e,t)=>{e&&e.id!==(t==null?void 0:t.id)&&await v(e)},{immediate:!1});const P=async()=>{if(!a.currentProject)return;const e=a.currentProject;try{await a.getProjectsByWorkspace(e.workspaceId);const t=a.workspaceProjects.find(n=>n.id===e.id);d(t||e)}catch(t){console.error("❌ 載入工程項目資料失敗:",t),d(e),l.$toast.error("載入工程項目資料失敗")}},d=e=>{g.value=!0;try{const t={A1:"甲等",A2:"甲等",B1:"乙等",B2:"乙等",C1:"丙等",C2:"丙等"},n={中央政府:"一般預算",地方政府:"一般預算",前瞻基礎建設計畫:"前瞻基礎建設計畫",專案補助:"專案補助",特別預算:"特別預算"};c.value={project_name:e.name||"",contract_number:e.contractNumber||"",project_location:e.location||"",host_agency:e.hostAgency||"",supervision_unit:e.supervisionUnit||"",contractor_name:e.contractorName||"",construction_period:e.constructionPeriod||"",project_amount:e.budget||"",project_grade:t[e.projectGrade]||e.projectGrade||"",current_contract_amount:e.currentContractAmount||e.budget||"",project_category:e.projectCategory||"",funding_source:n[e.fundingSource]||e.fundingSource||"",sign_date:e.signDate?e.signDate.split("T")[0]:"",start_date:e.startDate?e.startDate.split("T")[0]:"",completion_date:e.endDate?e.endDate.split("T")[0]:"",construction_confirm_date:e.constructionConfirmDate?e.constructionConfirmDate.split("T")[0]:"",construction_project_id:e.constructionProjectId||"",payment_method:e.paymentMethod||"",advance_payment_ratio:e.advancePaymentRatio||"",retention_ratio:e.retentionRatio||"",inspection_methods:e.inspectionMethods||[],segmented_acceptance:e.segmentedAcceptance||!1,partial_acceptance:e.partialAcceptance||!1,completion_acceptance:e.completionAcceptance||!1,insurance_policy_number:e.insurancePolicyNumber||"",insurance_company:e.insuranceCompany||"",insurance_start_date:e.insuranceStartDate?e.insuranceStartDate.split("T")[0]:"",insurance_end_date:e.insuranceEndDate?e.insuranceEndDate.split("T")[0]:"",insurance_type:e.insuranceType||"",signLevel:e.signLevel||[]}}finally{g.value=!1}},y=e=>{if(i.value)return e.preventDefault(),e.returnValue="您有未保存的變更，確定要離開嗎？","您有未保存的變更，確定要離開嗎？"},h=async()=>{u.value?await u.value.handleSubmit():(console.error("❌ 無法找到 ProjectForm 組件引用"),l.$toast.error("表單組件未正確載入，請重新整理頁面"))},C=async e=>{s.value=!0;try{await S(e),f.value=JSON.parse(JSON.stringify(c.value)),i.value=!1,l.$toast.success("工程資料保存成功！")}catch(t){console.error("保存失敗:",t),l.$toast.error("保存失敗，請重試！")}finally{s.value=!1}},S=async e=>{const t=a.currentProject;if(!t)throw new Error("沒有選擇工程項目");const n=a.currentWorkspace;if(!n)throw new Error("沒有選擇工作空間");const m=e||c.value,B=M(m,n.id),x=await z(t.id,B),F=`eip-workspace-projects-${n.id}`;localStorage.removeItem(F),await a.getProjectsByWorkspace(n.id);const _=a.workspaceProjects.find(N=>N.id===t.id);return _&&(a.updateProject(t.id,_),a.setCurrentProject(_,!1),d(_)),x},k=()=>{i.value&&!window.confirm("確定要重置表單嗎？所有未保存的變更將會丟失。")||(c.value=JSON.parse(JSON.stringify(f.value)),i.value=!1,u.value&&u.value.handleReset(),l.$toast.info("表單已重置"))};return E(async()=>{console.log("🚀 BasicData: 頁面載入..."),console.log("🔧 工程項目編輯器開啟 - 模式: edit"),a.isInitialized?console.log("✅ BasicData: 工作空間已初始化"):(console.log("🔄 BasicData: 工作空間未初始化，開始初始化..."),await a.initWorkspaces(),console.log("✅ BasicData: 工作空間初始化完成")),a.currentProject?(console.log("🔄 BasicData: 開始載入工程項目資料..."),await v(a.currentProject)):console.log("⚠️ BasicData: 沒有當前工程項目"),window.addEventListener("beforeunload",y),console.log("✅ BasicData: 頁面載入完成")}),O(()=>{window.removeEventListener("beforeunload",y)}),I((e,t,n)=>{i.value?window.confirm("您有未保存的變更，確定要離開嗎？")?n():n(!1):n()}),(e,t)=>{const n=J("PageHeader");return w(),b($,null,[D(n,{title:"基本資料維護",icon:"fa fa-edit",breadcrumbs:[{text:"表單生成與管理",href:"javascript:;"},{text:"基本資料維護",active:!0}]}),r("div",q,[r("div",G,[D(j,{ref_key:"projectFormRef",ref:u,class:"mb-4",modelValue:c.value,"onUpdate:modelValue":t[0]||(t[0]=m=>c.value=m),mode:"edit","is-submitting":s.value,"show-submit-button":!1,"show-reset-button":!1,onSubmit:C},null,8,["modelValue","is-submitting"]),r("div",K,[r("button",{type:"button",class:"btn btn-outline-secondary",onClick:k,disabled:s.value},t[1]||(t[1]=[r("i",{class:"fa fa-undo me-1"},null,-1),p(" 重置 ")]),8,Q),r("button",{type:"button",class:"btn btn-theme",onClick:h,disabled:s.value},[r("i",{class:U(["fa me-1",{"fa-spin fa-spinner":s.value,"fa-save":!s.value}])},null,2),p(" "+W(s.value?"處理中...":"保存"),1)],8,X)]),i.value?(w(),b("div",Y,t[2]||(t[2]=[r("i",{class:"fa fa-exclamation-triangle me-2"},null,-1),p(" 您有未保存的變更 ")]))):L("",!0)])])],64)}}}),oe=H(Z,[["__scopeId","data-v-d7869a8a"]]);export{oe as default};
